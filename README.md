# ERP USERSIDE Docker Bundle v3.16.1

## О проекте
Данный проект представляет собой **набор образцов** конфигурационных файлов и скриптов для запуска Docker-бандла системы ERP USERSIDE. Все необходимые для работы ERP USERSIDE образы уже собраны со всеми необходимыми зависимостями и настройками и размещены в [Docker HUB](https://hub.docker.com/repository/docker/erpuserside/userside). Вы можете на основе данных образцов собрать свой бандл, используя Docker-composer либо испльзуя другие, удобные вам, инструменты оркестрации. Вы также можете воспользоваться образцами как есть и получить работающую систему ERP USERSIDE без каких либо дополнительных действий. Мы полностью полагаемся на ваше понимание работы контейнеризации в Linux, работы Docker, docker-compose, swarm и других систем, которые вы собираетесь использовать.

Данные образцы Docker-окружения распространяются «как есть» без каких либо гарантий. Мы также не оказываем техническую поддержку по вопросам установки, настройки и обслуживания Docker и связанных с ним инструментов. Если вы не знакомы с Docker, то вам следует воспользоваться классическим примером установки ERP USERSIDE на Linux-сервер.

## Важное замечание
Официальный стабильный релиз ERP USERSIDE 3.16 еще выпущен. Данная инструкция адаптирована для использования DEV-версии ERP USERSIDE. После выхода стабильного релиза ERP USERSIDE 3.16 инструкция будет изменена, а изменения влиты в **master**.

## Установка
1. Выделите доменное имя для ERP USERSIDE и создайте необходимые записи на DNS-сервере либо в файле /etc/hosts на текущем сервере, проверьте, что имя разрешается в IP-адрес корректно.
2. Загрузите и установите Docker и docker-compose.
3. Создайте каталог, в котором будет размещаться бандл, и перейдите в него. Например: `sudo mkdir -p /docker && cd $_`
4. Склонируйте этот репозиторий в подкаталог userside и перейдитие в него: `sudo git clone https://github.com/userside/userside-docker.git userside && cd userside`. Переключитесь на ветку **v3.16** выполнив: `sudo git checkout v3.16`. Если вы до этого уже загружали эту ветку, то вместо повторного клонирования репозитория и переключения на ветку v3.16 выполните команду `sudo git pull`.
5. Выполните команду инициализации `sudo ./init.sh` — она создаст копии образцов с рабочими именами файлов. Теперь у вас есть файлы **.env**, **docker-compose.yml**, **Makefile**.
6. Отредактируйте файл **.env** при помощи команды `sudo nano .env` — укажите в нем все значения переменных (путь для развёртывания файлов бандла, имя проекта, часовой пояс и локаль, логины и пароли для служб и т.д.)
7. При необходимости внесите изменения в файлы **docker-compose.yml** и **Makefile**, но, скорее всего, в этом нет необходимости. Вы можете подключить альтернативные файлы **php.ini** и **www.conf** из каталога **configs** раскомментировав соответствующие строки в файле **docker-compose.yml**.
8. Выполните команду `sudo make install` и следуйте инструкциям на экране.
9. После установки необходимо перезапустить бандл. Для этого выполните команду `sudo make restart`.
10. Если вы планируете включить экспериментальную функцию ERP USERSIDE для работы с websocket, то дополнительно нужно создать WebSTOMP-пользователя в RabbitMQ. Это можно сделать двумя способами на выбор:
    1. Либо выполнив набор команд:
    ```
    sudo docker-compose -p userside exec rabbitmq rabbitmqctl add_user "userside-stomp" "password"
    sudo docker-compose -p userside exec rabbitmq rabbitmqctl set_permissions -p "/" "userside-stomp" "^userside-stomp:id-.*" "" "^userside-stomp:id-.*"
    ```
    2. Либо через панель управления RabbitMQ. Для этого откройте в браузере http://your.userside.net:15672 (домен замените на тот что используется для ERP USERSIDE, имя пользователя и пароль такие, как вы задали в .env файле для переменных RABBITMQ_DEFAULT_USER и RABBITMQ_DEFAULT_PASS), перейдите на вкладку **Admin**, внизу в разделе **Add a user** в качестве имени пользователя укажите имя пользователя, например, userside-stomp и задайте пароль. Поле с тэгами оставьте пустым. Затем нажмите **Add user**. Теперь выше в разделе **All users** кликните по только что созданному пользователю, чтобы открыть его параметры. В разделе **Permissions** для **Configure regexp** и для **Read regexp** задайте значение `^userside-stomp:id-.*`, а для **Write regexp** удалите значение, оставив поле пустым. Нажмите кнопку **Set permission**.

## Обновление
### В пределах версии бандла 3.16
Никаких дополнительных действий не требуется. Запустите команду `sudo make update` и следуйте инструкциям.

### С версии бандла 3.12, 3.13 до версии 3.16
#### Изменения
+ Теперь все значения переменных (логины, пароли и прочее) вынесены в `.env` файл.
+ Redis теперь требует обязательной установки пароля
+ Добавлены сервисы, необходимые для работы USERSIDE 3.16 (RabbitMQ, воркер ядра, воркер поллера)

#### Порядок обновления
1. Выполните резервное копирование и остановите работу бандла командами `sudo make backup && sudo make stop`.
2. Переключитесь на ветку **v3.16** выполнив `sudo git checkout v3.16`.
3. Переименуйте файл docker-compose.yml `sudo mv docker-compose.yml docker-compose_3-13.yml`.
4. Удалите файл Makefile, если вы не вносили в него никаких изменений. Иначе переменуйте и его.
5. Выполните команду инициализации `./init.sh` — она создает рабочие файлы копируя шаблонные файлы примеров.
6. Из файла **docker-compose_3-13.yml** перенесите все значения переменных в файл **.env**. Укажите в значении переменной `USERSIDE_BASE_DIR` полный путь к каталогу, в котором развернут бандл (текущему каталогу).
7. Теперь пароль для Redis обязателен. Если у вас раньше не было пароля, задайте его в переменной `REDIS_PASSWORD` файла **.env**, а затем добавьте в файл **.env** расположенный в каталоге userside переменную `US_REDIS_PASSWORD` с точно таким же паролем.
8. Скорее всего, ваши прежние docker-compose.yml и Makefile больше не понадобятся. Скопируйте их куда нибудь на всякий случай, пока обновление не завершится. Потом их можно будет удалить.
9. Скопируйте шаблонные файлы `cp docker-compose.yml-example docker-compose.yml` и `cp Makefile-example Makefile`. Если в ваших прежних одноименных файлах были какие-то специальные изменения, то перенесите их в новые файлы, если в этом действительно есть необходимость. Скорее всего это не понадобится.
10. В файле `.env` имеются переменные, отвечающие за количество контейнеров, запускаемых для сервисов-обработчиков: `CORE_WORKER_NUM` и `POLLER_NUM`. По умолчанию они установлены в 10 и 5 соответственно. Если вам нужно больше обработчиков — измените эти цифры здесь. Для начала рекомендуем оставить их по умолчанию.
11. Запустите инсталляцию командой `sudo make install`. При обновлении с версии 3.13 на 3.16 нужно выполнить именно эту команду, а не **update**. В дальнейшем при обновлении в пределах версии 3.16 нужно будет использовать `sudo make update`.
12. Проследите, чтобы установка прошла корректно.
13. Удалите файл **docker-compose_3-13.yml** — он больше не нужен. Если вы сохраняли файл Makefile (п.4), перенесите из него все ваши изменения в новый Makefile.


## Эксплуатация
### Резервное копирование
Сценарием автоматического развёртывания устанавливаются и настраиваются все необходимые компоненты системы, в том числе периодическое резервное копирование (задание помещается в системный cron).

### Фоновые процессы и RabbitMQ
Для мониторинга состояния брокера RabbitMQ используется модуль **RabbitMQ management** WEB-интерфейс которого доступен по адресу http://your.userside.net:15672 (домен замените на тот что используется для ERP USERSIDE, имя пользователя и пароль такие, как вы задали в .env файле для переменных RABBITMQ_DEFAULT_USER и RABBITMQ_DEFAULT_PASS).

Если фоновые задания выполняются с большой задержкой, вам следует обратить внимание на загруженность очередей (на вкладке Queues) и если очереди постоянно или довольно часто и подолну содержат относительно большое количество сообщений, вы можете изменить количество запускаемых экземпляров фоновых процессов для каждой из них.

Очередь **userside** отвечает за сообщения, передаваемые обработчику ядра. Количество экземпляров этого обработчика можно задать в переменной окружения `CORE_WORKER_NUM` в файле **.env** бандла (не userside).

Очередь **network_poller** отвечает за сообщения, передаваемые микросервису поллера, который выполняет операции по взаимодействию с оборудованием. Количество экземпляров этого микросервиса можно задать в переменной окружения `POLLER_NUM` в файле **.env** бандла (не userside).

Если значения для этих переменных изменялись, необходимо перезагрузить бандл командой `sudo make restart`.

---

Ознакомьтесь пожалуйста [с этой статьей WIKI](https://wiki.userside.eu/Docker_%D0%BE%D0%BA%D1%80%D1%83%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5).

---