# ERP USERSIDE Docker Bundle v3.16.8

## О проекте
Данный проект представляет собой **набор образцов** конфигурационных файлов и скриптов для запуска Docker-бандла системы ERP USERSIDE. Все необходимые для работы ERP USERSIDE образы уже собраны со всеми необходимыми зависимостями и настройками и размещены в [Docker HUB](https://hub.docker.com/repository/docker/erpuserside/userside). Вы можете на основе данных образцов собрать свой бандл, используя Docker-composer либо испльзуя другие, удобные вам, инструменты оркестрации. Вы также можете воспользоваться образцами как есть и получить работающую систему ERP USERSIDE без каких либо дополнительных действий. Мы полностью полагаемся на ваше понимание работы контейнеризации в Linux, работы Docker, docker-compose, swarm и других систем, которые вы собираетесь использовать.

Данные образцы Docker-окружения распространяются «как есть» без каких либо гарантий. Мы также не оказываем техническую поддержку по вопросам установки, настройки и обслуживания Docker и связанных с ним инструментов. Если вы не знакомы с Docker, то вам следует воспользоваться классическим примером установки ERP USERSIDE на Linux-сервер.

В пределах этой инструкции используется версия Docker-бандла, которая соответствует минимальной версии USERSIDE, способной работать на этой версии бандла. Например, на версии Docker-бандла 3.13 может работать USERSIDE версий 3.13, 3.14, 3.15, а на версии Docker-бандла 3.16 может работать USERSIDE 3.16, 3.17 и т.д., пока не появится новая версия бандла для какой-то очередной версии USERSIDE. Не путайте версию Docker-бандла с версией USERSIDE.

## Установка
1. Выделите доменное имя для ERP USERSIDE и создайте необходимые записи на DNS-сервере либо в файле /etc/hosts на текущем сервере, проверьте, что имя разрешается в IP-адрес корректно.
2. Загрузите и установите Docker и docker-compose.
3. Создайте каталог, в котором будет размещаться бандл, и перейдите в него. Например:
```
sudo mkdir -p /docker && cd $_
```
4. Склонируйте этот репозиторий в подкаталог userside и перейдитие в него:
```
sudo git clone --depth 1 https://github.com/userside/userside-docker.git userside && cd userside
```
5. Выполните команду инициализации конфигов бандла — она создаст копии образцов с рабочими именами файлов. Теперь у вас есть файлы **.env**, **docker-compose.yml**, **Makefile**:
```
sudo ./init.sh
```
6. Отредактируйте файл **.env** при помощи команды `sudo nano .env` — укажите в нем все значения переменных (путь для развёртывания файлов бандла, имя проекта, часовой пояс и локаль, логины и пароли для служб и т.д.)
7. Необязательно, только при необходимости, внесите изменения в файлы **docker-compose.yml** и **Makefile**. Например, вы можете подключить альтернативные файлы **php.ini** и **www.conf** из каталога **configs** раскомментировав соответствующие строки в файле **docker-compose.yml**, а затем скопировав файлы из применов (в каталоге config) и отредактировав их в соответствии с необходимостью. Или же изменить адрес выделяемой для бандла IP-подсети.
8. Запустиите установку бандла и ERP USERSIDE следующей командой и следуйте инструкциям:
```
sudo make install
```
9. После установки необходимо перезапустить бандл, чтобы запустить корректно все фоновые процессы:
```
sudo make restart
```
10. Создать WebSTOMP-пользователя для работы websocket одним из следующих способов. Пароль не обязательно должен быть слишком сложным, но и не должен быть похож ни на один из ваших паролей, так как он передается в открытом виде в Frontend приложение. Вместо `stompuser` и `password` укажите ваши, регулярные выражения оставьте как есть:
    1. Либо выполнив команду:
    ```
    sudo make STOMP_USER="stompuser" STOMP_PASSWORD="password" rabbitmq-create-stomp-user
    ```
    2. Либо через панель управления RabbitMQ. Для этого откройте в браузере http://your.userside.net:15672 (домен замените на тот что используется для ERP USERSIDE, имя пользователя и пароль такие, как вы задали в .env файле для переменных RABBITMQ_DEFAULT_USER и RABBITMQ_DEFAULT_PASS), перейдите на вкладку **Admin**, внизу в разделе **Add a user** в качестве имени пользователя укажите имя пользователя, например, stompuser и задайте пароль. Поле с тэгами оставьте пустым. Затем нажмите **Add user**. Теперь выше в разделе **All users** кликните по только что созданному пользователю, чтобы открыть его параметры. В разделе **Permissions** для **Configure regexp** и для **Read regexp** задайте значение `^userside-stomp:id-.*`, а для **Write regexp** удалите значение, оставив поле пустым. Нажмите кнопку **Set permission**.

Имя WebSTOMP-пользователя и пароль указываются в USERSIDE в меню: Настройка - Основная - Websocket.

## Обновление
### В пределах версии Docker-бандла 3.16
Для обновления ERP USERSIDE в пределах бандла версии 3.16 никаких дополнительных действий не требуется. Запустите команду и следуйте инструкциям:
```
sudo make update
```

### С версии Docker-бандла 3.12, 3.13 до версии 3.16
При обновлении ERP USERSIDE до версии 3.16 также необходимо обновить и Docker-бандл до версии 3.16. Обновленный бандл включает новый набор контейнеров, необходимый для работы фоновых процессов и брокера для управления сообщениями между ними, которые появились в ERP USERSIDE 3.16.

#### Изменения
+ Теперь все значения переменных (логины, пароли и прочее) вынесены в `.env` файл.
+ Redis теперь требует обязательной установки пароля
+ Добавлены сервисы, необходимые для работы USERSIDE 3.16 (RabbitMQ, воркер ядра, воркер поллера)

#### Порядок обновления
1. Выполните резервное копирование и остановите работу бандла:
```
sudo make backup && sudo make stop
```
2. Если вместо **master** вы используете ветку **v3.13**, то переключитесь на ветку **v3.16** (либо на ветку **master**, чтобы всегда получать самую последнюю стабильную версию бандла):
```
sudo git checkout v3.16
sudo git pull
```
3. Переименуйте ваш текущий файл docker-compose.yml чтобы не затереть его содержимое в процессе обновления:
```
sudo mv docker-compose.yml docker-compose_3-13.yml
```
4. Удалите файл Makefile, если вы не вносили в него никаких изменений. Иначе переменуйте и его.
```
sudo rm Makefile
```
5. Выполните команду инициализации — она создает рабочие файлы копируя шаблонные файлы примеров:
```
sudo ./init.sh
```
6. Из файла **docker-compose_3-13.yml** перенесите все значения переменных в файл **.env**. Укажите в значении переменной `USERSIDE_BASE_DIR` полный путь к каталогу, в котором развернут бандл (текущему каталогу). В данном примере это `/docker/userside`.
7. Начиная с версии бандла 3.16 пароль для Redis **обязателен**. Если у вас раньше не было пароля, задайте его в переменной `REDIS_PASSWORD` файла **.env**, а затем добавьте в файл **./data/userside/.env** переменную `US_REDIS_PASSWORD` с точно таким же паролем.
8. В файле `.env` имеются переменные, отвечающие за количество контейнеров, запускаемых для сервисов-обработчиков: `CORE_WORKER_NUM` и `POLLER_NUM`. По умолчанию они установлены в 10 и 5 соответственно. Если вам нужно больше обработчиков — измените эти цифры здесь. Для начала **рекомендуем оставить их по умолчанию**.
9. Запустите инсталляцию. При обновлении с версии бандла 3.13 на 3.16 нужно выполнить именно эту команду, а не **update**. В дальнейшем при обновлении в пределах версии бандла 3.16 нужно будет использовать `sudo make update`.
```
sudo make install
```
10. Проследите, чтобы обновление до ERP USERSIDE 3.16 прошло корректно.
11. Удалите файл **docker-compose_3-13.yml** — он больше не нужен. Если вы сохраняли файл Makefile (п.4), перенесите из него все ваши изменения в новый Makefile и удалите старый.
```
sudo rm docker-compose_3-13.yml
```

## Эксплуатация
Большинство необходимых в эксплуатации команд перечислены в Makefile и имеют короткие имена, например, `sudo make install` или `sudo make update`. Далее приводится полный список всех команд, доступных через утилиту `make`.

### Список сокращенных команд
#### Основные команды
+ `up` — запустить все контейнеры бандла
+ `down` или `stop`— остановить все контейнеры бандла
+ `restart` — перезапустить все контейнеры бандла. Выполнится последовательно `down` и затем `up`
+ `install` — запуск инициализации окружения для бандла, затем запуск инсталлятора для установки и после чего инициализации задач в планировщике cron и других постинсталляционных процессов
+ `userside-install` — запуск инсталлятора с командой **install**
+ `userside-repair` — запуск инсталлятора с командой **repair**
+ `update` — выполнение всех необходимых процедур для проведения обновления бандла и USERSIDE, включая предварительное резервное копирование
+ `uninstall` — удаление Docker-бандла и задач планировщика cron. Файлы USERSIDE не удаляются
+ `purge` — то же самое, что и **uninstall**, но также безвозвратно удаляются все файлы USERSIDE
+ `log` — отображение журнала работы Docker-контейнеров
+ `flush` — очистка кэшей и очередей
+ `backup` — выполнение резервного копирования
+ `dbrestore` — восстановление базы данных из резервной копии (см. ниже как использовать)

#### Вспомогательные команды
+ `postgres-psql` — запуск консольной утилиты **psql** для взаимодействия с базой данных
+ `rabbitmq-cleanup` — очистка очередей RabbitMQ

#### Собственные команды
Все выше перечисленные сокращенные команды используют утилиту `docker-compose` для запуска тех или иных процессов внутри контейнеров бандла. При необходимости Вы можете дополнить их список самостоятельно, отредактировав файл Makefile.

Если по Вашему мнению сокращенная команда пригодится не только Вам, но и большинству пользователей, Вы можете добавить ее в шаблонный `Makefile-example` и прислать Poll Request в репозиторий проекта.

### Резервное копирование
Сценарием автоматического развёртывания устанавливаются и настраиваются все необходимые компоненты системы, в том числе периодическое резервное копирование (задание помещается в системный cron). Архивы размещаются в подкаталоге **data/backup** бандла.

Если Вам необходимо выполнить внеочередное резервное копирование, запустите команду
```
sudo make backup
```
Будет создан новый архив.

#### Восстановление
Для восстановления резервной копии необходимо через переменную окружения передать имя файла (без пути), находящегося в подкаталоге **./data/backup**, из которого необходимо произвести восстановление. Например:
```
sudo make DUMP="userside_2019-05-08_09-23-19.dump" dbrestore
```

### Фоновые процессы и RabbitMQ
Для мониторинга состояния брокера RabbitMQ используется модуль **RabbitMQ management** WEB-интерфейс которого доступен по адресу http://your.userside.net:15672 (домен замените на тот что используется для ERP USERSIDE, имя пользователя и пароль такие, как вы задали в **.env** файле для переменных `RABBITMQ_DEFAULT_USER` и `RABBITMQ_DEFAULT_PASS`).

Если фоновые задания выполняются с большой задержкой, вам следует обратить внимание на загруженность очередей (на вкладке Queues) и если очереди постоянно или довольно часто и подолну содержат относительно большое количество сообщений, вы можете изменить количество запускаемых экземпляров фоновых процессов для каждой из них.

Очередь **userside** отвечает за сообщения, передаваемые обработчику ядра. Количество экземпляров этого обработчика можно задать в переменной окружения `CORE_WORKER_NUM` в файле **.env** бандла (не userside).

Очередь **network_poller** отвечает за сообщения, передаваемые микросервису поллера, который выполняет операции по взаимодействию с оборудованием. Количество экземпляров этого микросервиса можно задать в переменной окружения `POLLER_NUM` в файле **.env** бандла (не userside).

Если значения для этих переменных изменялись, необходимо перезагрузить бандл
```
sudo make restart
```

## Тонкая настройка
Для достижения максимальной производительности рекомендуется произвести тонкую настройку окружения. Принципы описаны [на нашей специальной wiki-странице](https://wiki.userside.eu/Tuning).

### PHP и FPM
Изменять настройки для служб Docker-бандла можно при помощи подключаемых через тома (volumes) файлов. В файле **docker-compose.yml** для служб **php**, **fpm** имеются закомментированные тома для файлов, в которых можно разместить дополнительные опции для тонкой настройки.

Скопируйте файлы php.ini-example и www.conf-example в подкаталоге config в файлы php.ini и www.conf соответственно и отредактируйте их. Затем ракомментируйте соответствующие тома (volumes) в службах php и fpm файла docker-compose.yml и перезапустите бандл:
```
sudo make restart
```

### PostgreSQL
Файлы конфигурации PostgreSQL находятся в подкаталоге data/db и могут быть отредактированы прямо там. После редактирования нужно так же перезапустить бандл:
```
sudo make restart
```

## Использование дополнительных модулей USERSIDE
Файл docker-compose.yml содержит службу **usm_billing** представляющую собой реализацию модуля взаимодействия с биллинговыми системами. Эта служба добавлена в качестве примера и если в ней нет необходимости, может быть удалена из конфигурации. Если же Вы используете этот модуль, то Вам необходимо заполнить основные параметры в блоке `environment` этой службы: `USERSIDE_API_KEY`, `BILLING_NAME`, `BILLING_URL`, `BILLING_ID`. Остальные параметры — по необходимости. Параметр `USERSIDE_API_URL` в случае использования внутри бандла заполнять не нужно: имя сервера подставится автоматически.

[В нашем репозитории](https://github.com/orgs/userside/repositories) вы можете найти примеры использования в Docker других модулей. Примеры содержат фрагмент конфигурации бандла, который можно использовать в файле docker-compose.yml вашего бандла и пошаговую инструкцию по установке и настройке модуля внутри бандла.

Если для интересующего Вас модуля нет подобного примера использования, Вы можете создать его самостоятельно на примере других модулей.

## Использование нескольких бандлов на одном сервере
При необходимости использования нескольких копий USERSIDE на одном сервере, необходимо организовать несколько бандлов — по одному на каждую копию. Если основной каталого, в котором планируется разместить все бандлы, является `/docker` (согласно этой инструкции), и, например, нужно использовать две отдельных копии USERSIDE, то проделайте следующее.

### Установка
#### Развёртывание
Создайте каталог `/docker`, если он еще не создан, и перейдите в него:
```
sudo mkdir -p /docker && cd $_
```

Склонируйте репозиторий дважды. Указывайте понятное имя для каждого бандла, чтобы в будущем точно знать где какой:
```
sudo git clone --depth 1 https://github.com/userside/userside-docker.git userside-production
sudo git clone --depth 1 https://github.com/userside/userside-docker.git userside-testing
```
В результате вы получите два каталога: /docker/userside-production и /docker/userside-testing в каждом из которых будет размещаться своя версия бандла.

#### Конфигурирование
Перейдите в каждый из каталогов и выполните инициализацию:
```
cd /docker/userside-production && sudo ./init.sh
cd /docker/userside-testing && sudo ./init.sh
```

##### Файл .env
Теперь отредактируйте файл `.env` в каждом из каталогов бандлов. Вам необходимо обязательно указать абсолютный путь к бандлу (переменная `USERSIDE_BASE_DIR`) и имя проекта (переменная `PROJECT_NAME`), например, **userside-production** и **userside-testing**.

При необходимости измените остальные переменные. Например, для тестовой копии USERSIDE вовсе не обязательно запускать 10 копий core_worker процессов и также не обязательно запускать 5 копий микросервисов поллеров. Для тестовой копии будет достаточно по одной копии, так как нагрузка на тестовую копию предполагается минимальной.

##### Файл docker-compose.yml
Теперь необходимо внести измение в файл настройки бандла `docker-compose.yml`. Здесь необходимо изменить только настройки, касающиеся сети. Бандлы должны использовать разные подсети, а размер подсети должен быть достаточным, чтобы уместить все контейнеры бандла с некоторым запасом.

По умолчанию в примере этого файла используется подсеть 172.31.254.0/25. Если эта подсеть подходит Вам (не пересекается с имеющимися подсетями на предприятии), то оставьте ее такой в одном из бандлов, а во втором измените на, например, 172.31.254.128/25. Для этого в блоке настроек **networks** необходимо изменить значение для параметра **subnet**.

Первый адрес узла из каждой подсети будет отдан интерфейсу хоста, а остальные случайным образом назначены контейнерам бандла. В данном примере IP-адреса 172.31.254.1 и 172.31.254.129 будут назначены интерфейсам bridgeXXX на хосте. Эти адреса удобно использовать для трансляции портов контейнеров.

Просмотрите внимательно параметр **ports** всех служб (services) в docker-compose.yml. Он содержит список портов, которые необходимо транслировать для каждого из сервисов. Например, запись `"172.31.254.1:8080:80"` для службы **nginx** означает, что порт 8080 интерфейса с адресом 172.31.254.1 на хосте должен транслироваться на порт 80 внутри контейнера с nginx. Это позволяет получить сетевой доступ внутрь бандла к контейнеру, обращаясь к IP адресу хоста.

Измените адреса так, чтобы ими были адреса первых узлов в соответствующей подсети. Для описываемого примера это 127.31.254.1 для первого бандла и 172.31.254.129 для второго бандла.

Удалите комментарий со строки, транслирующей порт WebSTOMP с номером 15674 сервиса rabbitmq. Это нужно сделать при использовании реверсивного прокси перед бандлом.

### Реверсивный HTTP-прокси
Мы рекомендуем использовать реверсивный прокси даже если у вас на сервере одна копия Usersdide. Это позволяет более гибко настроить web доступ. Например, использовать SSL либо настроить необходимые права доступа. Но если для одного бандла реверсивный прокси не всегда необходим, но при использовании двух и более бандлов его необходимость практически безоговорочна.

![Два бандла с одним реверсивным прокси](/img/nginx.png)

Установите NGINX и настройте его как реверсивный прокси следующим способом. В примере используются имена доменов **userside.company.net** для рабочей копии userside и **test-us.company.net** для тестовой копии userside. Если у вас одна копия, используйте один блок `server`. Пример:
```
server {
    listen 80;
    server_name userside.company.net;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://172.31.254.1:8080;
        proxy_send_timeout 240;
        proxy_read_timeout 240;
    }

    location /ws {
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_pass http://172.31.254.1:15674/ws;
        proxy_http_version 1.1;
    }
}

server {
    listen 80;
    server_name test-us.company.net;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://172.31.254.129:8080;
        proxy_send_timeout 240;
        proxy_read_timeout 240;
    }

    location /ws {
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_pass http://172.31.254.129:15674/ws;
        proxy_http_version 1.1;
    }
}
```

## Дополнения и исправления
Будем благодарны за обратную связь, предложения и сообщения о найденых ошибках в данном Docker-окружении для USERSIDE. О них Вы можете сообщать через Issue систему этого репозитория. Также будем рады предложениям и исправлениям в виде Poll Request.